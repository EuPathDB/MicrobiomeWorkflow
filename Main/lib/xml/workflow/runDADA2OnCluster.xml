<workflowGraph name="runDADA2OnCluster">
  <param name="projectName"/>
  <param name="parentDataDir"/>
  <param name="extDBName"/>
  <param name="multiplexed"/>
  <param name="barcodesType"/>
  <param name="samplesInfoFile"/>
  <param name="isPaired"/>
  <param name="trimLeft"/>
  <param name="trimLeftR"/>
  <param name="truncLen"/>
  <param name="truncLenR"/>
  <param name="readLen"/>
  <param name="platform"/>
  <param name="sraStudyId"/>
  <param name="mergeTechReps"/>

  <constant name="fastqDir">$$parentDataDir$$/$$extDBName$$/final</constant>
  <constant name="dataDir">$$parentDataDir$$/$$extDBName$$/cluster</constant>
  <constant name="taxonRefFile">$$parentDataDir$$/DADA2Taxonomy_RSRC/DADA2Taxonomy_trainSet.fa.gz</constant>
  <constant name="samplesInfoFile">$$parentDataDir$$/$$extDBName$$/final/$$samplesInfoFile$$</constant>

  <step name="makeClusterDir" stepClass="ReFlow::StepClasses::MakeDataDir">
    <paramValue name="dataDir">$$extDBName$$/cluster</paramValue>
  </step>

  <step name="mirrorDatadirToCluster" stepClass="ReFlow::StepClasses::MirrorToComputeCluster" stepLoadTypes="toCluster">
    <paramValue name="fileOrDirToMirror">$$extDBName$$</paramValue>
    <depends name="makeClusterDir"/>
  </step>
<!--
  <step name="mirrorClusterdirToCluster" stepClass="ReFlow::StepClasses::MirrorToComputeCluster" stepLoadTypes="toCluster">
    <paramValue name="fileOrDirToMirror">$$extDBName$$/cluster</paramValue>
    <depends name="mirrorDatadirToCluster"/>
  </step>
-->
  <step name="makeDADA2InputDir" stepClass="MicrobiomeWorkflow::Main::WorkflowSteps::MakeDADA2TaskInputDir">
    <paramValue name="taskInputDir">$$dataDir$$/input</paramValue>
    <paramValue name="fastqDir">$$fastqDir$$</paramValue>
    <paramValue name="multiplexed">$$multiplexed$$</paramValue>
    <paramValue name="keepNode">yes</paramValue>
    <paramValue name="barcodesType">$$barcodesType$$</paramValue>
    <paramValue name="samplesInfoFile">$$samplesInfoFile$$</paramValue>
    <paramValue name="isPaired">$$isPaired$$</paramValue>
    <paramValue name="trimLeft">$$trimLeft$$</paramValue>
    <paramValue name="trimLeftR">$$trimLeftR$$</paramValue>
    <paramValue name="truncLen">$$truncLen$$</paramValue>
    <paramValue name="truncLenR">$$truncLenR$$</paramValue>
    <paramValue name="readLen">$$readLen$$</paramValue>
    <paramValue name="taxonRefFile">$$taxonRefFile$$</paramValue>
    <paramValue name="platform">$$platform$$</paramValue>
    <paramValue name="sraStudyId">$$sraStudyId$$</paramValue>
    <paramValue name="mergeTechReps">$$mergeTechReps$$</paramValue>
    <depends name="makeClusterDir"/>
  </step>

  <step name="mirrorToCluster" stepClass="ReFlow::StepClasses::MirrorToComputeCluster" stepLoadTypes="toCluster">
    <paramValue name="fileOrDirToMirror">$$dataDir$$/input</paramValue>
    <depends name="makeDADA2InputDir"/>
    <depends name="mirrorDatadirToCluster"/>
  </step>

  <step name="runClusterTask" stepClass="ReFlow::StepClasses::RunAndMonitorDistribJob">
    <paramValue name="taskInputDir">$$dataDir$$/input</paramValue>
    <paramValue name="numNodes">20</paramValue>
    <paramValue name="maxMemoryGigs">15</paramValue>
    <paramValue name="processorsPerNode">1</paramValue>
    <depends name="mirrorToCluster"/>
  </step>

  <step name="mirrorFromCluster" stepClass="ReFlow::StepClasses::MirrorFromComputeCluster" stepLoadTypes="fromCluster">
    <paramValue name="fileOrDirToMirror">$$dataDir$$/master</paramValue>
    <paramValue name="outputDir">$$dataDir$$/master/mainresult</paramValue>
    <paramValue name="outputFiles">TODO</paramValue>
    <paramValue name="deleteAfterCopy">true</paramValue>
    <depends name="runClusterTask"/>
  </step>

</workflowGraph>
