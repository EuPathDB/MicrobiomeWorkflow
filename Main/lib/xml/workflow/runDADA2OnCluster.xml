<workflowGraph name="runDADA2OnCluster">
  <param name="datasetName"/>
  <param name="samplesInfoFile"/>
  <param name="isPaired"/>
  <param name="trimLeft"/>
  <param name="trimLeftR"/>
  <param name="truncLen"/>
  <param name="truncLenR"/>
  <param name="readLen"/>
  <param name="platform"/>
  <param name="sraStudyId"/>
  <param name="mergeTechReps"/>
  <param name="trainingSetPath"/>
  <param name="speciesAssignmentPath"/>
  <param name="resultDir"/>
  <param name="resultFileName"/>

  <step name="makeDADA2PropsDir" stepClass="MicrobiomeWorkflow::Main::WorkflowSteps::MakeDADA2TaskInputDir">
    <paramValue name="propsDir">$$datasetName$$/props</paramValue>
    <paramValue name="workingDir">$$datasetName$$/working</paramValue>
    <paramValue name="trainingSetPath">$$trainingSetPath$$</paramValue>
    <paramValue name="speciesAssignmentPath">$$speciesAssignmentPath$$</paramValue>
    <paramValue name="resultPath">$$resultDir$$/$$resultFileName$$</paramValue>
    <paramValue name="keepNode">yes</paramValue>
    <paramValue name="samplesInfoFile">$$samplesInfoFile$$</paramValue>
    <paramValue name="samplesInfoDir">$$datasetName$$</paramValue>
    <paramValue name="isPaired">$$isPaired$$</paramValue>
    <paramValue name="trimLeft">$$trimLeft$$</paramValue>
    <paramValue name="trimLeftR">$$trimLeftR$$</paramValue>
    <paramValue name="truncLen">$$truncLen$$</paramValue>
    <paramValue name="truncLenR">$$truncLenR$$</paramValue>
    <paramValue name="readLen">$$readLen$$</paramValue>
    <paramValue name="platform">$$platform$$</paramValue>
    <paramValue name="fastqsDir">$$datasetName$$/fastqsFromManualDelivery</paramValue>
    <paramValue name="sraStudyId">$$sraStudyId$$</paramValue>
    <paramValue name="mergeTechReps">$$mergeTechReps$$</paramValue>
  </step>

  <step name="mirrorPropsAndSupplementaryDataToCluster" stepClass="ReFlow::StepClasses::MirrorToComputeCluster" stepLoadTypes="toCluster">
    <paramValue name="fileOrDirToMirror">$$datasetName$$</paramValue>
    <depends name="makeDADA2PropsDir"/>
  </step>

  <step name="runClusterTask" stepClass="ReFlow::StepClasses::RunAndMonitorDistribJob">
    <paramValue name="taskInputDir">$$datasetName$$/props</paramValue>
    <paramValue name="numNodes">20</paramValue>
    <paramValue name="maxMemoryGigs">15</paramValue>
    <paramValue name="processorsPerNode">1</paramValue>
    <depends name="mirrorPropsAndSupplementaryDataToCluster"/>
  </step>

  <step name="mirrorResultsFromCluster" stepClass="ReFlow::StepClasses::MirrorFromComputeCluster" stepLoadTypes="fromCluster">
    <paramValue name="fileOrDirToMirror">$$resultDir$$/$$resultFileName$$</paramValue>
    <paramValue name="outputDir">$$resultDir$$</paramValue>
    <paramValue name="outputFiles">$$resultFileName$$</paramValue>
    <paramValue name="deleteAfterCopy">false</paramValue>
    <depends name="runClusterTask"/>
  </step>

</workflowGraph>
