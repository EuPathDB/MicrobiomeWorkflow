<workflowGraph name="runNfCoreFuncscanOnCluster">
  <param name="memoryInGb"/>
  <param name="nextflowTowerAccessToken"/>
  <param name="nextflowTowerWorkspaceId"/>
  <param name="sampleToFastqFileName"/>
  <param name="analysisDir"/>
  <param name="resultDir"/>
  <param name="magAnalysisDir"/>
  <param name="pipelineVersion"/>

  <step name="makeNfCoreFuncscanPMACSConfig" stepClass="MicrobiomeWorkflow::Main::WorkflowSteps::MakeNfCorePMACSConfig">
    <paramValue name="analysisDir">$$analysisDir$$</paramValue>
    <paramValue name="clusterResultDir">$$analysisDir$$/results</paramValue>
    <paramValue name="configFileName">nextflow.config</paramValue>
    <paramValue name="memoryInGb">$$memoryInGb</paramValue>
    <paramValue name="nextflowTowerAccessToken">$$nextflowTowerAccessToken</paramValue>
    <paramValue name="nextflowTowerWorkspaceId">$$nextflowTowerWorkspaceId</paramValue>
  </step>

  <step name="makeNfCoreFuncscanSamplesheet" stepClass="MicrobiomeWorkflow::Main::WorkflowSteps::MakeNfCoreFuncscanSamplesheet">
    <paramValue name="analysisDir">$$analysisDir$$</paramValue>
    <paramValue name="sampleToFastqFileName">$$sampleToFastqFileName</paramValue>
    <paramValue name="magAnalysisDir">$$magAnalysisDir</paramValue>

  <!-- TODO also some ref dbs to manage here -->
  <step name="makeNfCoreFuncscanParamsFile" stepClass="MicrobiomeWorkflow::Main::WorkflowSteps::MakeNfCoreFuncscanParamsFile">
    <paramValue name="analysisDir">$$analysisDir$$</paramValue>

  <step name="mirrorToCluster" stepClass="MicrobiomeWorkflow::Main::MirrorToComputeCluster" stepLoadTypes="toCluster">
    <paramValue name="fileOrDirToMirror">$$analysisDir$$</paramValue>
    <depends name="makeNfCoreFuncscanPMACSConfig"/>
    <depends name="makeNfCoreFuncscanSamplesheet"/>
    <depends name="makeNfCoreFuncscanParamsFile"/>
  </step>

  <step name="runClusterTask" stepClass="ReFlow::StepClasses::RunAndMonitorNextflow">
    <paramValue name="workingDir">$$analysisDir$$</paramValue>
    <paramValue name="resultsDir">$$analysisDir$$/results</paramValue>
    <paramValue name="nextflowConfigFile">$$analysisDir$$/nextflow.config</paramValue>
    <paramValue name="nextflowParamsFile">$$analysisDir$$/nf-params.json</paramValue>
    <paramValue name="nextflowWorkflow">nf-core/funcscan</paramValue>
    <paramValue name="isNfCoreWorkflow">true</paramValue>
    <paramValue name="pipelineVersion">$$pipelineVersion$$</paramValue>
    <depends name="mirrorToCluster"/>
  </step>

  <step name="retrieveNfCoreFuncscanResultsFromComputeCluster" stepClass="MicrobiomeWorkflow::Main::RetrieveNfCoreFuncscanResultsFromComputeCluster" stepLoadTypes="fromCluster">
    <paramValue name="clusterDir">$$analysisDir$$/results</paramValue>
    <paramValue name="targetDir">$$resultDir$$</paramValue>
    <depends name="runClusterTask"/>
  </step>
</workflowGraph>

