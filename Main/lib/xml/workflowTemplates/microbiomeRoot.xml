<workflowGraph name="">
  <param name="projectName"/>
  <param name="projectVersionForWebsiteFiles"/>
 

  <constant name="relativeWebServicesDir">webServices/$$projectName$$/release-$$projectVersionForWebsiteFiles$$</constant>
  <constant name="relativeDownloadSiteDir">downloadSite/$$projectName$$/release-$$projectVersionForWebsiteFiles$$/</constant>
  <constant name="relativeAuxiliaryDir">auxiliary/$$projectName$$/release-$$projectVersionForWebsiteFiles$$/</constant>


<!--  <constant name="globalDataDir">global</constant>-->

  <globalSubgraph name="microbiomeGlobal" xmlFile="microbiomeGlobal.xml">
    <paramValue name="globalDatasetLoaderXmlFile">microbiomeGlobal.xml</paramValue>
    <paramValue name="projectName">$$projectName$$</paramValue>
  </globalSubgraph>
  

  <step name="makeProjectReleaseDownloadDir" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InitSiteDir">
    <paramValue name="relativeDir">$$relativeDownloadSiteDir$$</paramValue>
    <dependsGlobal name="initUserGroupProject"/>
  </step>
  
  <step name="makeProjectReleaseWebServicesDir" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InitSiteDir">
    <paramValue name="relativeDir">$$relativeWebServicesDir$$</paramValue>
    <dependsGlobal name="initUserGroupProject"/>
  </step>
  
  <step name="makeProjectReleaseAuxiliaryDir" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InitSiteDir">
    <paramValue name="relativeDir">$$relativeAuxiliaryDir$$</paramValue>
    <dependsGlobal name="initUserGroupProject"/>
  </step>

  <datasetTemplate class="NASeqFromFasta">
    <prop name="projectName"/>
    <prop name="version"/>
    <prop name="name"/>
    
    <subgraph name="NASeqFromFasta_${name}_RSRC" xmlFile="loadDataset.xml">
      <paramValue name="datasetName">NASeqFromFasta_${name}_RSRC</paramValue>
      <paramValue name="datasetLoaderXmlFileName">${projectName}.xml</paramValue>
      <paramValue name="parentDataDir"></paramValue>
      <dependsGlobal name="taxonomy"/>
      <dependsGlobal name="SO"/>
    </subgraph>
  </datasetTemplate>

  <datasetTemplate class="taxonMapping">
    <prop name="projectName"/>
    <prop name="name"/>
    <prop name="version"/>
    
    <subgraph name="taxonMapping_${name}" xmlFile="loadDataset.xml">
      <paramValue name="datasetName">taxonMapping_${name}_RSRC</paramValue>
      <paramValue name="datasetLoaderXmlFileName">${projectName}.xml</paramValue>
      <paramValue name="parentDataDir"></paramValue>
      <dependsPattern name="NASeqFromFasta*"/>
      <dependsGlobal name="taxonomy"/>
    </subgraph>
  </datasetTemplate>


  <datasetTemplate class="otuProfiles">
    <prop name="projectName"/>
    <prop name="name"/>
    <prop name="version"/>

    
    <subgraph name="otuProfiles_${name}" xmlFile="loadDataset.xml">
      <paramValue name="datasetName">otu_${name}_RSRC</paramValue>
      <paramValue name="datasetLoaderXmlFileName">${projectName}.xml</paramValue>
      <paramValue name="parentDataDir"></paramValue>
      <dependsPattern name="NASeqFromFasta*"/>
      <dependsGlobal name="oboOntologies"/>
    </subgraph>
  
    <subgraph name="${name}_analyzeOtuExperiment" xmlFile="analyzeGenericProfileExperiment.xml">
      <paramValue name="parentDataDir"></paramValue>
      <paramValue name="experimentDatasetName">otu_${name}_RSRC</paramValue>
      <paramValue name="experimentDatasetVersion">${version}</paramValue>
      <paramValue name="hasTimeSeries">no</paramValue>
      <paramValue name="organismAbbrev">DONT CARE</paramValue>
      <paramValue name="relativeDownloadSiteDir">$$relativeDownloadSiteDir$$</paramValue>
      <paramValue name="studyName">OTU Profiles ${name}</paramValue>
      <paramValue name="technologyType">OTU</paramValue>
      <dependsPattern name="otuProfiles_${name}"/>  <!-- should be depends name instead of dependsPattern name -->
    </subgraph>
  </datasetTemplate>


<!-- TODO add dataset class in classes xml for DADA2Taxonomy
     load nothing plugin with manual get for not yet determined filename
     make dataset in microbiome datasets  -->
  <subgraph name="DADA2Taxonomy" xmlFile="loadDataset.xml">
    <paramValue name="datasetName">DADA2Taxonomy_RSRC</paramValue>
    <paramValue name="datasetLoaderXmlFileName">$$projectName$$.xml</paramValue>
    <paramValue name="parentDataDir"></paramValue>
  </subgraph>

  <step name="mirrorDADA2TaxonomyToCluster" stepClass="ReFlow::StepClasses::MirrorToComputeCluster" stepLoadTypes="toCluster">
      <paramValue name="fileOrDirToMirror">DADA2Taxonomy_RSRC</paramValue>
      <depends name="DADA2Taxonomy"/>
  </step>

<!--
  <datasetTemplate class="otuProfilesDADA2">
    <prop name="projectName"/>
    <prop name="name"/>
    <prop name="version"/>
    <prop name="multiplexed"/>
    <prop name="barcodesType"/>
    <prop name="samplesInfoFile"/>
    <prop name="isPaired"/>
    <prop name="trimLeft"/>
    <prop name="trimLeftR"/>
    <prop name="truncLen"/>
    <prop name="truncLenR"/>
    <prop name="readLen"/>
 
    <subgraph name="otuProfilesDADA2_${name}" xmlFile="loadDataset.xml">
      <paramValue name="datasetName">otuDADA2_${name}_RSRC</paramValue>
      <paramValue name="datasetLoaderXmlFileName">${projectName}.xml</paramValue>
      <paramValue name="parentDataDir"></paramValue>
      <dependsGlobal name="oboOntologies"/>
      <depends name="mirrorDADA2TaxonomyToCluster"/>
      <dependsGlobal name="taxonomy"/>
    </subgraph>

    <subgraph name="runDADA2OnCluster_${name}" xmlFile="runDADA2OnCluster.xml">
       <paramValue name="projectName">$$projectName$$</paramValue>
       <paramValue name="parentDataDir">$$dataDir$$</paramValue>
       <paramValue name="extDBName">otuDADA2_${name}_RSRC</paramValue>
       <paramValue name="multiplexed">$$multiplexed$$</paramValue>
       <paramValue name="barcodesType">$$barcodesType$$</paramValue>
       <paramValue name="samplesInfoFile">$$samplesInfoFile$$</paramValue>
       <paramValue name="isPaired">$$isPaired$$</paramValue>
       <paramValue name="trimLeft">$$trimLeft$$</paramValue>
       <paramValue name="trimLeftR">$$trimLeftR$$</paramValue>
       <paramValue name="truncLen">$$truncLen$$</paramValue>
       <paramValue name="truncLenR">$$truncLenR$$</paramValue>
       <paramValue name="readLen">$$readLen$$</paramValue>
      <depends name="otuProfilesDADA2_${name}"/>
    </subgraph> 

    <step name="loadTaxonMapping_${name}" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::TODO">
     TODO param here for path to dada taxonomy output
    TODO pass the external dbname
    
    </step>

    <subgraph name="${name}_analyzeOtuExperiment" xmlFile="analyzeGenericProfileExperiment.xml">
      <paramValue name="parentDataDir"></paramValue>
      <paramValue name="experimentDatasetName">otuDADA2_${name}_RSRC</paramValue>
      <paramValue name="experimentDatasetVersion">${version}</paramValue>
      <paramValue name="hasTimeSeries">no</paramValue>
      <paramValue name="organismAbbrev">DONT CARE</paramValue>
      <paramValue name="relativeDownloadSiteDir">$$relativeDownloadSiteDir$$</paramValue>
      <paramValue name="studyName">OTU Profiles ${name}</paramValue>
       TODO check following line
      <paramValue name="technologyType">OTU</paramValue>
      <depends name="loadTaxonMapping_${name}"/>  
    </subgraph>

 </datasetTemplate>
-->

 <subgraph name="ISASimpleMicrobiome" xmlFile="loadDataset.xml">
    <paramValue name="datasetName">ISASimple_RSRC</paramValue>
    <paramValue name="datasetLoaderXmlFileName">$$projectName$$.xml</paramValue>
    <paramValue name="parentDataDir"></paramValue>
    <dependsPattern name="*Experiment"/>
    <dependsGlobal name="oboOntologies"/>
    <dependsGlobal name="eupathCuratedOntologies"/>
  </subgraph>

</workflowGraph>

