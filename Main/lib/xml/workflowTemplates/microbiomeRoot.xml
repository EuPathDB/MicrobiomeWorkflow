<workflowGraph name="">
  <param name="projectName"/>
  <param name="projectVersionForWebsiteFiles"/>
 

  <constant name="relativeWebServicesDir">webServices/$$projectName$$/release-$$projectVersionForWebsiteFiles$$</constant>
  <constant name="relativeDownloadSiteDir">downloadSite/$$projectName$$/release-$$projectVersionForWebsiteFiles$$/</constant>
  <constant name="relativeAuxiliaryDir">auxiliary/$$projectName$$/release-$$projectVersionForWebsiteFiles$$/</constant>


<!--  <constant name="globalDataDir">global</constant>-->

  <globalSubgraph name="microbiomeGlobal" xmlFile="microbiomeGlobal.xml">
    <paramValue name="globalDatasetLoaderXmlFile">microbiomeGlobal.xml</paramValue>
    <paramValue name="projectName">$$projectName$$</paramValue>
  </globalSubgraph>
  
  <step name="makeProjectReleaseDownloadDir" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InitSiteDir">
    <paramValue name="relativeDir">$$relativeDownloadSiteDir$$</paramValue>
    <dependsGlobal name="initUserGroupProject"/>
  </step>
  
  <step name="makeProjectReleaseWebServicesDir" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InitSiteDir">
    <paramValue name="relativeDir">$$relativeWebServicesDir$$</paramValue>
    <dependsGlobal name="initUserGroupProject"/>
  </step>
  
  <step name="makeProjectReleaseAuxiliaryDir" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InitSiteDir">
    <paramValue name="relativeDir">$$relativeAuxiliaryDir$$</paramValue>
    <dependsGlobal name="initUserGroupProject"/>
  </step>

  <subgraph name="rRNAReference" xmlFile="loadDataset.xml">
    <paramValue name="datasetName">rRNAReference_RSRC</paramValue>
    <paramValue name="datasetLoaderXmlFileName">$$projectName$$.xml</paramValue>
    <paramValue name="parentDataDir"></paramValue>
  </subgraph>

  <step name="mirrorDADA2TaxonomyToCluster" stepClass="ReFlow::StepClasses::MirrorToComputeCluster" stepLoadTypes="toCluster">
    <paramValue name="fileOrDirToMirror">rRNAReference_RSRC</paramValue>
    <depends name="rRNAReference"/>
    <dependsGlobal name="initClusterHomeDir"/>
  </step>

  <datasetTemplate class="rRNAExperiment">
    <prop name="name"/>
    <prop name="version"/>
    <prop name="multiplexed"/>
    <prop name="barcodesType"/>
    <prop name="samplesInfoFile"/>
    <prop name="isPaired"/>
    <prop name="trimLeft"/>
    <prop name="trimLeftR"/>
    <prop name="truncLen"/>
    <prop name="truncLenR"/>
    <prop name="readLen"/>
    <prop name="platform"/>
    <prop name="sraStudyId"/>
    <prop name="mergeTechReps"/>

    <subgraph name="rRNAExperiment_${name}_copyManualDeliveryFiles" xmlFile="loadDataset.xml">
      <paramValue name="datasetName">otuDADA2_${name}_RSRC</paramValue>
      <paramValue name="datasetLoaderXmlFileName">${projectName}.xml</paramValue>
      <paramValue name="parentDataDir"></paramValue>
    </subgraph>

    <subgraph name="rRNAExperiment_${name}" xmlFile="runDADA2OnCluster.xml">
      <paramValue name="projectName">$$projectName$$</paramValue>
      <paramValue name="datasetName">otuDADA2_${name}_RSRC</paramValue>
      <paramValue name="trainingSetPath">rRNAReference_RSRC/trainingSet.fa.gz</paramValue>
      <paramValue name="speciesAssignmentPath">rRNAReference_RSRC/speciesAssignment.fa.gz</paramValue>
      <paramValue name="resultDir">all_results</paramValue>
      <paramValue name="resultFileName">${name}.lineage_abundance.tsv</paramValue>
      <paramValue name="version">${version}</paramValue>
      <paramValue name="multiplexed">${multiplexed}</paramValue>
      <paramValue name="barcodesType">${barcodesType}</paramValue>
      <paramValue name="samplesInfoFile">${samplesInfoFile}</paramValue>
      <paramValue name="isPaired">${isPaired}</paramValue>
      <paramValue name="trimLeft">${trimLeft}</paramValue>
      <paramValue name="trimLeftR">${trimLeftR}</paramValue>
      <paramValue name="truncLen">${truncLen}</paramValue>
      <paramValue name="truncLenR">${truncLenR}</paramValue>
      <paramValue name="readLen">${readLen}</paramValue>
      <paramValue name="platform">${platform}</paramValue>
      <paramValue name="sraStudyId">${sraStudyId}</paramValue>
      <paramValue name="mergeTechReps">${mergeTechReps}</paramValue>
      <depends name="otuProfilesDADA2_${name}"/>
    </subgraph>

    <step name="insertOtuAbundances_${name}" stepClass="MicrobiomeWorkflow::Main::WorkflowSteps::InsertOtuAbundances">
      <paramValue name="inputPath">all_results/${name}.lineage_abundance.tsv</paramValue>
      <paramValue name="datasetName">otuDADA2_${name}_RSRC</paramValue>
      <depends name="rRNAExperiment_${name}"/>
    </step>

  </datasetTemplate>

  <!-- Used to happen without dependencies, I'm not sure how it has ever worked -->
  <subgraph name="crossStudyCard" xmlFile="loadDataset.xml">
    <paramValue name="datasetName">CrossStudy_RSRC</paramValue>
    <paramValue name="datasetLoaderXmlFileName">$$projectName$$.xml</paramValue>
    <paramValue name="parentDataDir"></paramValue>
    <dependsPattern name="rRNAExperiment_*"/>
  </subgraph>

   <subgraph name="createLineageTaxonLinkingTable" xmlFile="loadDataset.xml">
    <paramValue name="datasetName">LineageTaxonLinkingTable_RSRC</paramValue>
    <paramValue name="datasetLoaderXmlFileName">$$projectName$$.xml</paramValue>
    <dependsPattern name="rRNAExperiment_*"/>
    <dependsGlobal name="taxonomy"/>
   </step>

 <!-- why is ontology stuff here instead of in global? -->
  <subgraph name="OBO_Ontology_fma_RSRC" stepLoadTypes="runPlugin:insertOntologyTermsAndRelationships" xmlFile="loadDataset.xml">
   <paramValue name="datasetName">OBO_Ontology_fma_RSRC</paramValue>
   <paramValue name="datasetLoaderXmlFileName">$$projectName$$.xml</paramValue>
   <paramValue name="parentDataDir">global/oboOntologies</paramValue>
   <dependsGlobal name="oboOntologies"/>
 </subgraph>

 <subgraph name="ISASimpleMicrobiome" xmlFile="loadDataset.xml">
    <paramValue name="datasetName">ISASimple_RSRC</paramValue>
    <paramValue name="datasetLoaderXmlFileName">$$projectName$$.xml</paramValue>
    <paramValue name="parentDataDir"></paramValue>
    <depends name="OBO_Ontology_fma_RSRC"/>
    <dependsPattern name="*Experiment"/> <!-- Wojtek: I think this doesn't match anything -->
    <dependsGlobal name="eupathCuratedOntologies"/>
  </subgraph>

  <!-- Should happen after all the analyses are done, and all the metadata has been inserted -->
  <step name="tuningManager"
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::MakeDerivedTables" stepLoadTypes="tuningManager">
    <paramValue name="tables">Samples,PANExtDbRls,Ontology,Metadata,TaxonRelativeAbundance</paramValue>
    <paramValue name="organismAbbrev"></paramValue>
      <depends name="ISASimpleMicrobiome"/>
      <dependsPattern name="rRNAExperiment_*"/>
      <depends name="crossStudyCard"/>
      <depends name="createLineageTaxonLinkingTable"/>
  </step>

  <step name="makeDownloadFileDir" stepClass="ReFlow::StepClasses::MakeDataDir">
    <paramValue name="dataDir">downloadSiteFiles</paramValue>
  </step>

  <step name="makeDownloadFiles"
        stepClass="MicrobiomeWorkflow::Main::WorkflowSteps::MakeDownloadFiles">
    <paramValue name="outputFileBaseName">downloadSite</paramValue>
    <depends name="makeDownloadFileDir"/>
    <depends name="tuningManager"/>
  </step>

  <step name="copyDownloadFiles" 
          stepClass="MicrobiomeWorkflow::Main::WorkflowSteps::CopyDownloadFiles">
    <paramValue name="inputFileBaseName">downloadSite</paramValue>
    <paramValue name="relativeDownloadSiteDir">$$relativeDownloadSiteDir$$</paramValue>
    <depends name="makeDownloadFiles"/>
    <depends name="makeProjectReleaseDownloadDir"/>
  </step>

</workflowGraph>
