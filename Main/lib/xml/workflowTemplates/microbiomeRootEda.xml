<workflowGraph name="">
  <param name="projectName"/>
  <param name="projectVersionForWebsiteFiles"/>

 
  <constant name="dataDir">${parentDataDir}/edaStudies</constant>

  <constant name="relativeDownloadSiteDir">downloadSite/$$projectName$$/release-$$projectVersionForWebsiteFiles$$/</constant>
  <constant name="datasetLoaderXmlFileName">MicrobiomeDB.xml</constant>

  <step name="makeProjectReleaseDownloadDir" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InitSiteDir">
    <paramValue name="relativeDir">$$relativeDownloadSiteDir$$</paramValue>
  </step>
  

<!--
  <globalSubgraph name="microbiomeGlobalEDA" xmlFile="microbiomeGlobalEDA.xml">
    <paramValue name="globalDatasetLoaderXmlFile">microbiomeGlobalEDA.xml</paramValue>
    <paramValue name="projectName">$$projectName$$</paramValue>
  </globalSubgraph>

    <subgraph name="OBO_Ontology_OBI_RSRC" xmlFile="loadDataset.xml" stepLoadTypes="runPlugin:insertOntologyTermsAndRelationships">
      <paramValue name="datasetName">OBO_Ontology_OBI_RSRC</paramValue>
      <paramValue name="datasetLoaderXmlFileName">$$datasetLoaderXmlFileName$$</paramValue>
      <paramValue name="parentDataDir"></paramValue>
      <depends name="Ontology_Relationship_Types_RSRC"/>
    </subgraph>

  <subgraph name="CommonTermsOwlEda" xmlFile="loadDataset.xml">
    <paramValue name="datasetName">OntologyTerm_EuPathIsa_RSRC</paramValue>
    <paramValue name="datasetLoaderXmlFileName">$$datasetLoaderXmlFileName$$</paramValue>
    <paramValue name="parentDataDir"></paramValue>
    <depends name="Ontology_Relationship_Types_RSRC"/>
  </subgraph>

  <subgraph name="taxonomy" xmlFile="loadDataset.xml">
    <paramValue name="datasetName">taxonomy_RSRC</paramValue>
    <paramValue name="datasetLoaderXmlFileName">$$datasetLoaderXmlFileName$$</paramValue>
    <paramValue name="parentDataDir"></paramValue>
    <dependsGlobal name="Ontology_Relationship_Types_RSRC"/>
  </subgraph>
-->

<!--
  <step name="beginMicrobiomeOwls" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::DoNothingStep">
    <depends name="initUserGroupProject"/>
    <depends name="Ontology_Relationship_Types_RSRC"/>
    <depends name="CommonTermsOwlEda"/>
    <depends name="OBO_Ontology_OBI_RSRC"/>
    <depends name="taxonomy"/>
  </step>

  <step name="beginCopyStudies" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::DoNothingStep">
    <depends name="initUserGroupProject"/>
  </step>

  <datasetTemplate class="MicrobiomeOwlEda">
    <prop name="name"/>

    <subgraph name="MicrobiomeOwlEda_${name}" xmlFile="loadDataset.xml">
      <paramValue name="datasetName">OntologyTerm_${name}_RSRC</paramValue>
      <paramValue name="datasetLoaderXmlFileName">$$datasetLoaderXmlFileName$$</paramValue>
      <paramValue name="parentDataDir"></paramValue>
      <depends name="beginMicrobiomeOwls"/>
    </subgraph>

  </datasetTemplate>

  <datasetTemplate class="WebDisplayOntologyEDA">
    <prop name="name"/>
    <prop name="sourceFile"/>
    <prop name="projectName"/>

    <subgraph name="OntologyTerm_${name}_RSRC" xmlFile="loadDataset.xml">
      <paramValue name="datasetName">OntologyTerm_${name}_RSRC</paramValue>
      <paramValue name="datasetLoaderXmlFileName">${projectName}.xml</paramValue>
      <paramValue name="sourceFile"></paramValue>
      <paramValue name="parentDataDir"></paramValue>
    </subgraph>
  </datasetTemplate>

  <datasetTemplate class="MicrobiomeStudyEda">
    <prop name="name"/>
    <prop name="version"/>
    <prop name="owl"/>
    <prop name="sampleDetailsDir"/>

    <subgraph name="MicrobiomeStudy_${name}_copyManualDeliveryAndInvestigationFiles" xmlFile="loadDataset.xml">
      <paramValue name="parentDataDir"></paramValue>
      <paramValue name="datasetName">MicrobiomeStudyEDA_${name}_RSRC</paramValue>
      <paramValue name="datasetLoaderXmlFileName">$$datasetLoaderXmlFileName$$</paramValue>
      <paramValue name="name">${name}</paramValue>
      <paramValue name="version">${version}</paramValue>
      <paramValue name="sampleDetailsDir">${sampleDetailsDir}</paramValue>
      <depends name="beginCopyStudies"/>
    </subgraph>

    <step name="MicrobiomeStudyEDA_${name}_RSRC_insertEntityGraph" stepClass="MicrobiomeWorkflow::Main::WorkflowSteps::MBioInsertEntityGraph" stepLoadTypes="plugin">
      <paramValue name="extDbRlsSpec">MicrobiomeStudyEDA_${name}_RSRC|${version}</paramValue>
      <paramValue name="schema">EDA</paramValue>
      <paramValue name="investigationFile">MicrobiomeStudyEDA_${name}_RSRC/final/${name}.xml </paramValue>
      <paramValue name="sampleDetailsFile">MicrobiomeStudyEDA_${name}_RSRC/final/${name}.txt </paramValue>
      <paramValue name="ontologyMappingFile">OntologyTerm_${owl}_RSRC/${owl}.owl</paramValue>
      <paramValue name="mbioResultsDir">MicrobiomeStudyEDA_${name}_RSRC/final</paramValue>
      <paramValue name="mbioResultsFileExtensions">'{ampliconTaxa => "lineage_abundance.tsv", wgsTaxa => "metaphlan.tsv", level4ECs => "level4ec.tsv", pathwayAbundances => "pathway_abundance.tsv", pathwayCoverages => "pathway_coverage.tsv", eukdetectCpms => "eukdetect.lineage_abundance.tsv", massSpec => "metabolomics.tsv" }'</paramValue>
      <paramValue name="dieOnFirstError">1</paramValue>
      <depends name="OntologyTerm_${owl}_RSRC"/>

      <depends name="MicrobiomeStudy_${name}_copyManualDeliveryAndInvestigationFiles"/>
    </step>

    <step name="MicrobiomeStudyEDA_${name}_RSRC_owlOverride" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::UpdateOntologySynonym" stepLoadTypes="plugin">
    	<paramValue name="plugin">GUS::Supported::Plugin::InsertOntologySynonymAttributes</paramValue>
      <paramValue name="webDisplayOntologyName">OntologyTerm_${owl}_RSRC|dontcare</paramValue>
      <paramValue name="attributesFile">owlAttributes.txt</paramValue>
      <paramValue name="dataDir">MicrobiomeStudyEDA_${name}_RSRC</paramValue>
      <paramValue name="enableUndo">1</paramValue>
      <depends name="OntologyTerm_${owl}_RSRC"/>
      <depends name="MicrobiomeStudyEDA_${name}_RSRC_insertEntityGraph"/>
    </step>

    <step name="MicrobiomeStudyEDA_${name}_RSRC_loadAttributesFromEntityGraph" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::LoadAttributesFromEntityGraph" stepLoadTypes="sqlldr">
      <paramValue name="logDir">EDA_${name}</paramValue>
      <paramValue name="extDbRlsSpec">MicrobiomeStudyEDA_${name}_RSRC|${version}</paramValue>
      <paramValue name="ontologyExtDbRlsSpec">OntologyTerm_${owl}_RSRC|dontcare</paramValue>
      <paramValue name="schema">EDA</paramValue>
      <depends name="MicrobiomeStudyEDA_${name}_RSRC_insertEntityGraph"/>
      <depends name="MicrobiomeStudyEDA_${name}_RSRC_owlOverride"/>
    </step>
    
    <step name="MicrobiomeStudyEDA_${name}_RSRC_loadEntityTypeAndAttributeGraphs" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::LoadEntityTypeAndAttributeGraphs" stepLoadTypes="plugin">
      <paramValue name="logDir">EDA_${name}</paramValue>
      <paramValue name="extDbRlsSpec">MicrobiomeStudyEDA_${name}_RSRC|${version}</paramValue>
      <paramValue name="ontologyExtDbRlsSpec">OntologyTerm_${owl}_RSRC|dontcare</paramValue>
      <paramValue name="schema">EDA</paramValue>
      <depends name="MicrobiomeStudyEDA_${name}_RSRC_loadAttributesFromEntityGraph"/>
    </step>
    
    <step name="MicrobiomeStudyEDA_${name}_RSRC_loadDatasetSpecificEntityGraph" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::LoadDatasetSpecificEntityGraph" stepLoadTypes="plugin">
      <paramValue name="extDbRlsSpec">MicrobiomeStudyEDA_${name}_RSRC|${version}</paramValue>
      <paramValue name="schema">EDA</paramValue>
      <depends name="MicrobiomeStudyEDA_${name}_RSRC_loadEntityTypeAndAttributeGraphs"/>
    </step>

    <step name="MicrobiomeStudyEDA_${name}_RSRC_makeEntityDownloadFiles" 
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertEDA">
    	<paramValue name="plugin">ApiCommonData::Load::Plugin::MakeEntityDownloadFiles</paramValue>
      <paramValue name="extDbRlsSpec">MicrobiomeStudyEDA_${name}_RSRC|${version}</paramValue>
      <paramValue name="fileBasename">${name}</paramValue>
      <paramValue name="webDisplayOntologyName">${owl}</paramValue>
      <paramValue name="dataDir">MicrobiomeStudyEDA_${name}_RSRC</paramValue>
      <paramValue name="outputDir"></paramValue>
    	<paramValue name="schema">EDA</paramValue>
      <depends name="MicrobiomeStudyEDA_${name}_RSRC_loadDatasetSpecificEntityGraph"/>
    </step>

    <step name="MicrobiomeStudyEDA_${name}_RSRC_copyEntityDownloadFiles" 
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::CopyShinyFilesToDownloadDir">
      <paramValue name="datasetName">MicrobiomeStudyEDA_${name}_RSRC</paramValue>
      <paramValue name="inputFileBaseName"></paramValue>
      <paramValue name="nameForFilenames"></paramValue>
      <paramValue name="relativeDownloadSiteDir">$$relativeDownloadSiteDir$$</paramValue>
      <depends name="MicrobiomeStudyEDA_${name}_RSRC_makeEntityDownloadFiles"/>
      <depends name="makeProjectReleaseDownloadDir"/>
    </step>

  </datasetTemplate>
-->
<!-- ###################################################### -->

  <step name="makeDataDir" stepClass="ReFlow::StepClasses::MakeDataDir">
    <paramValue name="dataDir">$$dataDir$$</paramValue>
  </step>

  <datasetTemplate class="MBioNF">
    <prop name="projectName"/>
    <prop name="subProjectName"/>
    <prop name="groupName"/>
    <prop name="studyName"/>
    <prop name="version"/>
    <prop name="webDisplayOntologyName"/>
    <prop name="nameForFilenames"/>

    <subgraph name="MicrobiomeStudyEDA_${studyName}_RSRC" xmlFile="loadEdaStudy.xml">
      <paramValue name="datasetName">MicrobiomeStudyEDA_${studyName}_RSRC</paramValue>
      <paramValue name="datasetLoaderXmlFileName">${projectName}.xml</paramValue>
      <paramValue name="parentDataDir">$$dataDir$$</paramValue>
      <paramValue name="datasetVersion">${version}</paramValue>
      <paramValue name="projectName">${projectName}</paramValue>
      <paramValue name="webDisplayOntologyName">${webDisplayOntologyName}</paramValue>
      <paramValue name="webDisplayOntologyFile">ontology/release/production/${webDisplayOntologyName}.owl</paramValue>
      <paramValue name="speciesReconciliationOntologySpec"></paramValue>
      <paramValue name="speciesReconciliationFallbackSpecies"></paramValue>
      <paramValue name="loadStudyCharacteristics">false</paramValue>
      <paramValue name="context">microbiome</paramValue>
      <paramValue name="optionalStudyStableId">${studyName}</paramValue>
      <paramValue name="studyClassificationsYaml"></paramValue>
      <paramValue name="studyClassificationsOwl"></paramValue>
    	<paramValue name="schema">EDA</paramValue>
      <depends name="makeDataDir"/>
<!--
      <dependsGlobal name="oboOntologies"/>
      <dependsGlobal name="Ontology_entityTypesAndProtocols_RSRC"/>
-->
    </subgraph>
  
<!--
    <step name="MicrobiomeStudyEDA_${studyName}_RSRC_makeEntityDownloadFiles" 
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertEDA">
    	<paramValue name="plugin">ApiCommonData::Load::Plugin::MakeEntityDownloadFiles</paramValue>
      <paramValue name="extDbRlsSpec">MicrobiomeStudyEDA_${studyName}_RSRC|${version}</paramValue>
      <paramValue name="fileBasename">${groupName}_${studyName}</paramValue>
      <paramValue name="webDisplayOntologyName">${webDisplayOntologyName}</paramValue>
      <paramValue name="dataDir">MicrobiomeStudyEDA_${studyName}_RSRC</paramValue>
      <paramValue name="outputDir"></paramValue>
    	<paramValue name="schema">EDA</paramValue>
      <depends name="MicrobiomeStudyEDA_${studyName}_RSRC"/>
    </step>
-->

    <step name="MicrobiomeStudyEDA_${studyName}_RSRC_copyEntityDownloadFiles" 
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::CopyShinyFilesToDownloadDir">
      <paramValue name="datasetName">MicrobiomeStudyEDA_${studyName}_RSRC</paramValue> 
      <paramValue name="nameForFilenames">${nameForFilenames}</paramValue>
      <paramValue name="filePath">edaStudies/MicrobiomeStudyEDA_${studyName}_RSRC/annPropsAndArtifacts/results</paramValue>
      <paramValue name="inputFileBaseName">MicrobiomeStudyEDA_${studyName}_RSRC</paramValue>
      <paramValue name="relativeDownloadSiteDir">$$relativeDownloadSiteDir$$</paramValue>
      <depends name="MicrobiomeStudyEDA_${studyName}_RSRC"/>
      <depends name="makeProjectReleaseDownloadDir"/>
    </step>
<!-- MicrobiomeDB doesn't have these 
    <step name="MicrobiomeStudyEDA_${studyName}_RSRC_manualDownloadFiles"
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::CopyDownloadFilesDirFromManualDelivery">
      <paramValue name="projectName">${projectName}</paramValue>
      <paramValue name="datasetName">MicrobiomeStudyEDA_${studyName}_RSRC</paramValue>
      <paramValue name="relativeManualDeliveryDir">${subProjectName}/${groupName}/${studyName}/${version}/final/downloadSiteFiles</paramValue>
      <paramValue name="relativeDownloadSiteDir">$$relativeDownloadSiteDir$$</paramValue>
      <depends name="makeProjectReleaseDownloadDir"/>
      <depends name="MicrobiomeStudyEDA_${studyName}_RSRC_copyEntityDownloadFiles"/>
    </step>
-->
  </datasetTemplate>
<!-- Experimental megastudy
  <datasetTemplate class="EDAMegaStudyMicrobiome">
    <prop name="projectName"/>
    <prop name="studyStableId"/>
    <prop name="version"/>
    <prop name="webDisplayOntologyName"/>

    <subgraph name="EDAMegaStudy_${studyStableId}_RSRC" xmlFile="loadEdaStudy.xml">
      <paramValue name="datasetName">EDAMegaStudy_${studyStableId}_RSRC</paramValue>
      <paramValue name="datasetLoaderXmlFileName">${projectName}.xml</paramValue>
      <paramValue name="parentDataDir">$$dataDir$$</paramValue>
      <paramValue name="datasetVersion">${version}</paramValue>
      <paramValue name="projectName">${projectName}</paramValue>
      <paramValue name="webDisplayOntologyName">${webDisplayOntologyName}</paramValue>
      <paramValue name="speciesReconciliationOntologySpec"></paramValue>
      <paramValue name="speciesReconciliationFallbackSpecies"></paramValue>
      <paramValue name="optionalStudyStableId">${studyStableId}</paramValue>
      <paramValue name="loadStudyCharacteristics">false</paramValue>
      <paramValue name="studyClassificationsYaml"></paramValue>
      <paramValue name="studyClassificationsOwl"></paramValue>
      <paramValue name="context">mega</paramValue>
      <dependsPattern name="MicrobiomeStudyEDA_BONUS*"/>
      <dependsPattern name="MicrobiomeStudyEDA_Ciara_V1V3*"/>
      <dependsPattern name="MicrobiomeStudyEDA_Ciara_V4*"/>
      <dependsPattern name="MicrobiomeStudyEDA_DailyBaby*"/>
    </subgraph>
  </datasetTemplate>
-->
</workflowGraph>
