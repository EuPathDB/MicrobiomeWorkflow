<workflowGraph name="">
  <param name="projectName"/>
  <param name="projectVersionForWebsiteFiles"/>

 

  <constant name="relativeWebServicesDir">webServices/$$projectName$$/release-$$projectVersionForWebsiteFiles$$</constant>
  <constant name="relativeDownloadSiteDir">downloadSite/$$projectName$$/release-$$projectVersionForWebsiteFiles$$/</constant>
  <constant name="relativeAuxiliaryDir">auxiliary/$$projectName$$/release-$$projectVersionForWebsiteFiles$$/</constant>
  <constant name="datasetLoaderXmlFileName">MicrobiomeDB.xml</constant>
  <step name="initUserGroupProject" 
	stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InitUserGroupProject">
    <paramValue name="projectName">$$projectName$$</paramValue>
  </step>

  <step name="makeProjectReleaseDownloadDir" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InitSiteDir">
    <paramValue name="relativeDir">$$relativeDownloadSiteDir$$</paramValue>
    <depends name="initUserGroupProject"/>
  </step>
  
  <step name="makeProjectReleaseWebServicesDir" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InitSiteDir">
    <paramValue name="relativeDir">$$relativeWebServicesDir$$</paramValue>
    <depends name="initUserGroupProject"/>
  </step>
  
  <step name="makeProjectReleaseAuxiliaryDir" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InitSiteDir">
    <paramValue name="relativeDir">$$relativeAuxiliaryDir$$</paramValue>
    <depends name="initUserGroupProject"/>
  </step>


  <subgraph name="Ontology_Relationship_Types_RSRC" xmlFile="loadDataset.xml">
    <paramValue name="datasetName">Ontology_Relationship_Types_RSRC</paramValue>
    <paramValue name="datasetLoaderXmlFileName">$$datasetLoaderXmlFileName$$</paramValue>
    <paramValue name="parentDataDir"></paramValue>
    <depends name="initUserGroupProject"/>
  </subgraph>

    <subgraph name="OBO_Ontology_OBI_RSRC" xmlFile="loadDataset.xml" stepLoadTypes="runPlugin:insertOntologyTermsAndRelationships">
      <paramValue name="datasetName">OBO_Ontology_OBI_RSRC</paramValue>
      <paramValue name="datasetLoaderXmlFileName">$$datasetLoaderXmlFileName$$</paramValue>
      <paramValue name="parentDataDir"></paramValue>
      <depends name="Ontology_Relationship_Types_RSRC"/>
    </subgraph>

  <subgraph name="CommonTermsOwlEda" xmlFile="loadDataset.xml">
    <paramValue name="datasetName">OntologyTerm_EuPathIsa_RSRC</paramValue>
    <paramValue name="datasetLoaderXmlFileName">$$datasetLoaderXmlFileName$$</paramValue>
    <paramValue name="parentDataDir"></paramValue>
    <depends name="Ontology_Relationship_Types_RSRC"/>
  </subgraph>

  <subgraph name="taxonomy" xmlFile="loadDataset.xml">
    <paramValue name="datasetName">taxonomy_RSRC</paramValue>
    <paramValue name="datasetLoaderXmlFileName">$$datasetLoaderXmlFileName$$</paramValue>
    <paramValue name="parentDataDir"></paramValue>
    <depends name="Ontology_Relationship_Types_RSRC"/>
  </subgraph>

  <step name="beginMicrobiomeOwls" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::DoNothingStep">
    <depends name="initUserGroupProject"/>
    <depends name="Ontology_Relationship_Types_RSRC"/>
    <depends name="CommonTermsOwlEda"/>
    <depends name="OBO_Ontology_OBI_RSRC"/>
    <depends name="taxonomy"/>
  </step>

  <step name="beginCopyStudies" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::DoNothingStep">
    <depends name="initUserGroupProject"/>
  </step>

  <datasetTemplate class="MicrobiomeOwlEda">
    <prop name="name"/>

    <subgraph name="MicrobiomeOwlEda_${name}" xmlFile="loadDataset.xml">
      <paramValue name="datasetName">OntologyTerm_${name}_RSRC</paramValue>
      <paramValue name="datasetLoaderXmlFileName">$$datasetLoaderXmlFileName$$</paramValue>
      <paramValue name="parentDataDir"></paramValue>
      <depends name="beginMicrobiomeOwls"/>
    </subgraph>

    <step name="MicrobiomeOwlEda_${name}_synonyms" stepClass="MicrobiomeWorkflow::Main::WorkflowSteps::LoadAnnotationsAsOntologySynonyms" stepLoadTypes="plugin">
      <paramValue name="extDbRlsSpec">OntologyTerm_${name}_RSRC|dontcare</paramValue>
      <paramValue name="attributesFile">OntologyTerm_${name}_RSRC/${name}.eda.txt</paramValue>
      <depends name="MicrobiomeOwlEda_${name}"/>
    </step>
  </datasetTemplate>

  <datasetTemplate class="MicrobiomeStudyEda">
    <prop name="name"/>
    <prop name="version"/>
    <prop name="owl"/>
    <prop name="sampleDetailsDir"/>

    <subgraph name="MicrobiomeStudy_${name}_copyManualDeliveryAndInvestigationFiles" xmlFile="loadDataset.xml">
      <paramValue name="parentDataDir"></paramValue>
      <paramValue name="datasetName">MicrobiomeStudyEDA_${name}_RSRC</paramValue>
      <paramValue name="datasetLoaderXmlFileName">$$datasetLoaderXmlFileName$$</paramValue>
      <paramValue name="name">${name}</paramValue>
      <paramValue name="version">${version}</paramValue>
      <paramValue name="sampleDetailsDir">${sampleDetailsDir}</paramValue>
      <depends name="beginCopyStudies"/>
    </subgraph>

    <step name="MicrobiomeStudyEDA_${name}_RSRC_insertEntityGraph" stepClass="MicrobiomeWorkflow::Main::WorkflowSteps::MBioInsertEntityGraph" stepLoadTypes="plugin">
      <paramValue name="extDbRlsSpec">MicrobiomeStudyEDA_${name}_RSRC|${version}</paramValue>
      <paramValue name="schema">EDA</paramValue>
      <paramValue name="investigationFile">MicrobiomeStudyEDA_${name}_RSRC/ISA/${sampleDetailsDir}/${name}.xml </paramValue>
      <paramValue name="sampleDetailsFile">MicrobiomeStudyEDA_${name}_RSRC/ISA/${sampleDetailsDir}/${name}.txt </paramValue>
      <paramValue name="ontologyMappingFile">OntologyTerm_${owl}_RSRC/${owl}.owl</paramValue>
      <paramValue name="mbioResultsDir">MicrobiomeStudyEDA_${name}_RSRC/results</paramValue>
      <paramValue name="mbioResultsFileExtensions">'{ampliconTaxa => "lineage_abundance.tsv", wgsTaxa => "metaphlan.tsv", level4ECs => "level4ec.tsv", pathwayAbundances => "pathway_abundance.tsv", pathwayCoverages => "pathway_coverage.tsv", eukdetectCpms => "eukdetect.lineage_abundance.tsv" }'</paramValue>
      <paramValue name="dieOnFirstError">1</paramValue>
      <depends name="MicrobiomeOwlEda_${owl}"/>

      <depends name="MicrobiomeStudy_${name}_copyManualDeliveryAndInvestigationFiles"/>
    </step>

    <step name="MicrobiomeStudyEDA_${name}_RSRC_loadAttributesFromEntityGraph" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::LoadAttributesFromEntityGraph" stepLoadTypes="sqlldr">
      <paramValue name="logDir">EDA_${name}</paramValue>
      <paramValue name="extDbRlsSpec">MicrobiomeStudyEDA_${name}_RSRC|${version}</paramValue>
      <paramValue name="ontologyExtDbRlsSpec">OntologyTerm_${owl}_RSRC|dontcare</paramValue>
      <paramValue name="schema">EDA</paramValue>
      <depends name="MicrobiomeOwlEda_${owl}_synonyms"/>
      <depends name="MicrobiomeStudyEDA_${name}_RSRC_insertEntityGraph"/>
    </step>
    
    <step name="MicrobiomeStudyEDA_${name}_RSRC_loadEntityTypeAndAttributeGraphs" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::LoadEntityTypeAndAttributeGraphs" stepLoadTypes="plugin">
      <paramValue name="logDir">EDA_${name}</paramValue>
      <paramValue name="extDbRlsSpec">MicrobiomeStudyEDA_${name}_RSRC|${version}</paramValue>
      <paramValue name="ontologyExtDbRlsSpec">OntologyTerm_${owl}_RSRC|dontcare</paramValue>
      <paramValue name="schema">EDA</paramValue>
      <depends name="MicrobiomeStudyEDA_${name}_RSRC_loadAttributesFromEntityGraph"/>
    </step>
    
    <step name="MicrobiomeStudyEDA_${name}_RSRC_loadDatasetSpecificEntityGraph" stepClass="ApiCommonWorkflow::Main::WorkflowSteps::LoadDatasetSpecificEntityGraph" stepLoadTypes="plugin">
      <paramValue name="extDbRlsSpec">MicrobiomeStudyEDA_${name}_RSRC|${version}</paramValue>
      <paramValue name="schema">EDA</paramValue>
      <depends name="MicrobiomeStudyEDA_${name}_RSRC_loadEntityTypeAndAttributeGraphs"/>
    </step>

    <step name="MicrobiomeStudyEDA_${name}_RSRC_makeEntityDownloadFiles" 
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::InsertEDA">
    	<paramValue name="plugin">ApiCommonData::Load::Plugin::MakeEntityDownloadFiles</paramValue>
      <paramValue name="extDbRlsSpec">MicrobiomeStudyEDA_${name}_RSRC|${version}</paramValue>
      <paramValue name="fileBasename">${name}</paramValue>
      <paramValue name="webDisplayOntologyName">${owl}</paramValue>
      <paramValue name="dataDir">MicrobiomeStudyEDA_${name}_RSRC</paramValue>
      <paramValue name="outputDir"></paramValue>
    	<paramValue name="schema">EDA</paramValue>
      <depends name="MicrobiomeStudyEDA_${name}_RSRC_loadDatasetSpecificEntityGraph"/>
    </step>

    <step name="MicrobiomeStudyEDA_${name}_RSRC_copyEntityDownloadFiles" 
          stepClass="ApiCommonWorkflow::Main::WorkflowSteps::CopyShinyFilesToDownloadDir">
      <paramValue name="datasetName">MicrobiomeStudyEDA_${name}_RSRC</paramValue>
      <paramValue name="inputFileBaseName"></paramValue>
      <paramValue name="nameForFilenames"></paramValue>
      <paramValue name="relativeDownloadSiteDir">$$relativeDownloadSiteDir$$</paramValue>
      <depends name="MicrobiomeStudyEDA_${name}_RSRC_makeEntityDownloadFiles"/>
      <depends name="makeProjectReleaseDownloadDir"/>
    </step>

  </datasetTemplate>
</workflowGraph>
